{% extends 'app/admin/admin.html' %}
{% load static %}

{% block title %}Users{% endblock %}

{% block content %}
<h1 class="mb-4 text-info">Users</h1>

{% if users %}
<div class="table-responsive">
  <input type="hidden" id="csrfToken" value="{{ csrf_token }}">
  <table class="table table-hover table-bordered align-middle shadow-sm rounded bg-dark text-light">
    <thead class="table-dark text-info text-center">
      <tr>
        <th scope="col">#</th>
        <th scope="col">Username</th>
        <th scope="col">Email</th>
        <th scope="col">Date Joined</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td class="text-center text-info">{{ user.id }}</td>
        <td>{{ user.username }}</td>
        <td>{{ user.email }}</td>
        <td>
          <span class="badge bg-info text-dark">
            {{ user.date_joined|date:"M d, Y" }}
          </span>
        </td>
        <td class="text-center align-middle">
          <a href="{% url 'edit_user' user.id %}" class="btn btn-sm btn-warning me-1" title="Edit">
            <i class="fas fa-edit"></i>
          </a>
          <button type="button" class="btn btn-sm btn-outline-danger delete-user-btn"
                  data-url="{% url 'delete_user' user.id %}" title="Delete">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="alert alert-warning">No users found.</div>
{% endif %}

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function getCSRFToken() {
    return document.getElementById('csrfToken').value;
}

document.querySelectorAll('.delete-user-btn').forEach(button => {
  button.addEventListener('click', function () {
    const url = this.getAttribute('data-url');
    Swal.fire({
      title: 'Are you sure?',
      text: "This user will be permanently deleted.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) throw new Error('Network error');
          return response.json();
        })
        .then(data => {
          if (data.status === 'success') {
            Swal.fire({
              title: 'Deleted!',
              text: data.message,
              icon: 'success',
              timer: 1500,
              showConfirmButton: false
            }).then(() => {
              window.location.reload();
            });
          } else {
            Swal.fire('Error!', data.message, 'error');
          }
        })
        .catch(() => {
          Swal.fire('Error!', 'Something went wrong. Try again.', 'error');
        });
      }
    });
  });
});
</script>
{% endblock %}
