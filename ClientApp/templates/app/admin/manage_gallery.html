{% extends 'app/admin/admin.html' %}
{% load static %}

{% block title %}Manage Gallery{% endblock %}

{% block content %}
<style>
  .editDeleteBtn {
    display: flex !important;
    justify-content: space-evenly !important; /* evenly spaces buttons */
    align-items: center; /* centers icons vertically */
    margin-top: 5px; /* optional, space above buttons */
}

.editDeleteBtn .btn {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 40px;   /* button width */
    height: 40px;  /* button height */
    padding: 0;    /* remove extra padding */
    border-radius: 5px; /* optional, rounded buttons */
}

.gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap: 1rem; }
.gallery-item { padding: 5px 6px; border: 1px solid white; position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
.gallery-item img { width: 100%; height: 140px; object-fit: cover; display: block; }
.timestamp { text-align: center; font-size: 0.8rem; color: #aaa; margin-top: 0.3rem; }
.edit-link, .delete-link { display: block; text-align: center; margin-top: 0.3rem; font-size: 0.85rem; cursor: pointer; }
.edit-link { color: #17a2b8; }
.edit-link:hover { text-decoration: underline; }
.delete-link { color: #dc3545; }
.delete-link:hover { text-decoration: underline; }
.upload-btn { background-color: #17a2b8; border: none; color: white; padding: 8px 16px; font-weight: 600; border-radius: 6px; cursor: pointer; margin-bottom: 1rem; display: inline-block; text-align: center; }

/* Modal */
.modal { display: none; position: fixed; z-index:1000; padding-top:60px; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.7);}
.modal-content { background-color:#222; margin:auto; padding:20px; border-radius:8px; width:90%; max-width:420px; color:#ddd; position:relative; }
.modal-content img { width:100%; height:200px; object-fit:contain; margin-bottom:1rem; border-radius:6px; }
.modal-close { color:#aaa; position:absolute; top:10px; right:15px; font-size:28px; font-weight:bold; cursor:pointer;}
.modal-close:hover { color:#fff; }
#uploadInput, #modalFileInput { display:none; }
</style>

<h2>Manage Gallery</h2>

<!-- Upload Button -->
<label class="upload-btn" for="uploadInput">âž• Upload New Image</label>
<input id="uploadInput" type="file" name="image" accept="image/*">

<!-- Gallery -->
<div class="gallery" id="galleryContainer">
  {% for img in gallery %}
  <div class="gallery-item" data-id="{{ img.pk }}">
    <img src="{{ img.image.url }}" alt="Gallery Image {{ forloop.counter }}">
    <div class="timestamp">{{ img.uploaded_at|date:"M d, Y H:i" }}</div>

    <div class="editDeleteBtn">
      <span class="btn btn-info text-white edit-link"
            data-id="{{ img.pk }}"
            data-img-url="{{ img.image.url }}"
            data-uploaded="{{ img.uploaded_at|date:"M d, Y H:i" }}">
        <i class="fa-solid fa-pen-to-square"></i>
      </span>

      <span class="btn btn-danger text-white delete-link" data-id="{{ img.pk }}">
        <i class="fa-solid fa-trash"></i>
      </span>
    </div>
  </div>
  {% empty %}
  <p>No images uploaded yet.</p>
  {% endfor %}
</div>


<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" id="modalClose">&times;</span>
    <h3>Edit Image</h3>
    <img id="currentImage" src="" alt="Current Image">
    <p id="uploadTimestamp" style="font-size:0.85rem; color:#bbb;"></p>
    <form id="editImageForm" method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      <label for="modalFileInput" class="upload-btn">Choose New File</label>
      <input id="modalFileInput" type="file" name="image" accept="image/*">
      <button type="submit" style="margin-top:10px;">Upload New Image</button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrfToken = getCookie('csrftoken');

const uploadInput = document.getElementById('uploadInput');
const galleryContainer = document.getElementById('galleryContainer');

// Upload Image
uploadInput.addEventListener('change', async function() {
  const file = uploadInput.files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append('image', file);
  formData.append('csrfmiddlewaretoken', csrfToken);

  try {
    const res = await fetch("{% url 'manage_gallery' %}", {
      method:'POST',
      headers:{'X-Requested-With':'XMLHttpRequest'},
      body:formData
    });
    const data = await res.json();
    if(data.success){
      Swal.fire({icon:'success', title:'Image uploaded!', timer:1500, showConfirmButton:false});
      const div = document.createElement('div');
      div.className='gallery-item';
      div.dataset.id = data.id;
      div.innerHTML = `
        <img src="${data.new_image_url}" alt="Gallery Image">
        <div class="timestamp">${data.uploaded_at}</div>
        <span class="edit-link" data-id="${data.id}" data-img-url="${data.new_image_url}" data-uploaded="${data.uploaded_at}">Edit Image</span>
        <span class="delete-link" data-id="${data.id}">Delete Image</span>
      `;
      galleryContainer.prepend(div);
      setupEditLinks();
      setupDeleteLinks();
    } else Swal.fire({icon:'error', title:'Upload Failed', text:data.error||'Unknown error'});
  } catch(err){ Swal.fire({icon:'error', title:'Network Error', text:err.message}); console.error(err);}
});

// Edit Modal
const modal = document.getElementById('editModal');
const modalClose = document.getElementById('modalClose');
const currentImage = document.getElementById('currentImage');
const uploadTimestamp = document.getElementById('uploadTimestamp');
const editImageForm = document.getElementById('editImageForm');

function setupEditLinks(){
  document.querySelectorAll('.edit-link').forEach(el=>{
    el.onclick = ()=>{
      const id = el.dataset.id;
      const imgUrl = el.dataset.imgUrl;
      const timestamp = el.dataset.uploaded;
      currentImage.src = imgUrl;
      uploadTimestamp.textContent = `Uploaded at: ${timestamp}`;
      editImageForm.action = "{% url 'edit_gallery_image' 0 %}".replace('0', id);
      modal.style.display='block';
    };
  });
}
setupEditLinks();

modalClose.onclick = ()=>{ modal.style.display='none'; editImageForm.reset(); };
window.onclick = e => { if(e.target===modal){ modal.style.display='none'; editImageForm.reset(); } }

editImageForm.addEventListener('submit', async e=>{
  e.preventDefault();
  const fileInput = document.getElementById('modalFileInput');
  if(!fileInput.files.length){ Swal.fire({icon:'warning', title:'No file selected'}); return; }
  const formData = new FormData(editImageForm);
  formData.append('csrfmiddlewaretoken', csrfToken);
  try{
    const res = await fetch(editImageForm.action, {
      method:'POST',
      headers:{'X-Requested-With':'XMLHttpRequest'},
      body:formData
    });
    const data = await res.json();
    if(data.success){
      const newUrl = data.new_image_url + '?t=' + new Date().getTime();
      currentImage.src=newUrl;
      uploadTimestamp.textContent=`Uploaded at: ${data.uploaded_at}`;
      const galleryItem=document.querySelector(`.gallery-item[data-id='${data.id}']`);
      galleryItem.querySelector('img').src=newUrl;
      galleryItem.querySelector('.timestamp').textContent=data.uploaded_at;
      galleryItem.querySelector('.edit-link').dataset.imgUrl=newUrl;
      galleryItem.querySelector('.edit-link').dataset.uploaded=data.uploaded_at;
      Swal.fire({icon:'success', title:'Image updated!', timer:1500, showConfirmButton:false});
      modal.style.display='none'; editImageForm.reset();
    } else Swal.fire({icon:'error', title:'Error', text:data.error||'Failed to update image'});
  } catch(err){ Swal.fire({icon:'error', title:'Network Error', text: err.message}); console.error(err);}
});

// Delete Image
function setupDeleteLinks(){
  document.querySelectorAll('.delete-link').forEach(el=>{
    el.onclick = async ()=>{
      const id = el.dataset.id;
      const result = await Swal.fire({
        title: 'Are you sure?',
        text: "This image will be permanently deleted!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
      });
      if(result.isConfirmed){
        try{
          const res = await fetch("{% url 'delete_gallery_image' 0 %}".replace('0', id), {
            method:'POST',
            headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrfToken}
          });
          const data = await res.json();
          if(data.success){
            document.querySelector(`.gallery-item[data-id='${id}']`).remove();
            Swal.fire({icon:'success', title:'Deleted!', timer:1200, showConfirmButton:false});
          } else Swal.fire({icon:'error', title:'Error', text:data.error||'Failed to delete'});
        } catch(err){ Swal.fire({icon:'error', title:'Network Error', text:err.message}); console.error(err);}
      }
    };
  });
}
setupDeleteLinks();
</script>

{% endblock %}
