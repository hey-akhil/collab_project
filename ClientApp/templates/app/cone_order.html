{% extends 'static_pages/base.html' %}
{% load static %}
{% block start %}
<link rel="stylesheet" href="{% static 'css/booking.css' %}">

<div class="booking-wrapper">
  <h2 class="mb-4 text-center">Place Your Mehndi Order</h2>

  <form id="orderForm" action="{% url 'place_order' %}" method="POST">
    {% csrf_token %}
    <div class="row justify-content-center">
      <!-- LEFT SIDE: Customer & Shipping Info -->
      <div class="col-md-6">
        <div class="mb-3">
          <label for="fullname">Full Name *</label>
          <input type="text" class="form-control" id="fullname" name="fullname" required>
        </div>

        <div class="mb-3">
          <label for="contact">Contact Number *</label>
          <input type="tel" class="form-control" id="contact" name="contact" required pattern="[0-9]{10}" placeholder="10-digit number">
        </div>

        <h5 class="mt-4">Shipping Address</h5>
        <div class="mb-3">
          <label for="add1">Address Line 1 *</label>
          <input type="text" class="form-control" id="add1" name="add1" required>
        </div>

        <div class="mb-3">
          <label for="street">Street *</label>
          <input type="text" class="form-control" id="street" name="street" required>
        </div>

        <div class="mb-3">
          <label for="city">City *</label>
          <input type="text" class="form-control" id="city" name="city" required>
        </div>

        <div class="mb-3">
          <label for="zipcode">Zip Code *</label>
          <input type="text" class="form-control" id="zipcode" name="zipcode" required pattern="[0-9]{6}">
        </div>

        <div class="mb-3">
          <label for="county">Country</label>
          <input type="text" class="form-control bg-light" id="county" name="county" value="India" readonly>
        </div>
      </div>

      <!-- RIGHT SIDE: Product Order Summary -->
      <div class="col-md-6" style="color: black;">
        <h5 class="mb-3">Order Summary</h5>
        {% if cart_items %}
          {% for item in cart_items %}
            <div class="d-flex mb-3 align-items-center border p-2 rounded">
              {% if item.product.image %}
                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" style="width: 60px; height: 60px; object-fit: cover; margin-right: 15px;">
              {% endif %}
              <div class="flex-grow-1">
                <strong>{{ item.product.name }}</strong><br>
                <small>{{ item.product.color }} | Size: {{ item.product.size }}</small><br>
                <span>â‚¹{{ item.product.price }} Ã— {{ item.quantity }}</span>
              </div>
              <div style="min-width: 80px; font-weight: bold; text-align: right; color: #d9534f;">
                â‚¹{{ item.subtotal }}
              </div>
            </div>
          {% endfor %}

          <hr>
          <h5 class="mt-3">Delivered At</h5>
          <div id="selected-address" class="border rounded-3 p-2 mb-2">
            {% if addresses %}
              <strong>{{ addresses.0.full_name }}</strong><br>
              {{ addresses.0.address_line1 }}, {{ addresses.0.street }}<br>
              {{ addresses.0.city }} - {{ addresses.0.zipcode }}, {{ addresses.0.country }}<br>
              <small>ðŸ“ž {{ addresses.0.contact }}</small>
              <input type="hidden" name="selected_address" id="selected_address_input" value="{{ addresses.0.id }}">
            {% else %}
              <p class="text-muted">No saved addresses. Please add one in your profile.</p>
            {% endif %}
          </div>

          <!-- Change Address Button -->
          {% if addresses|length > 1 %}
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addressModal">
              Change Address
            </button>
          {% endif %}

          <!-- Bootstrap Modal -->
          <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="addressModalLabel">Select Delivery Address</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  {% for addr in addresses %}
                    <div class="border rounded-3 p-2 mb-2 d-flex justify-content-between align-items-center address-option"
                      data-id="{{ addr.id }}"
                      data-fullname="{{ addr.full_name }}"
                      data-line1="{{ addr.address_line1 }}"
                      data-street="{{ addr.street }}"
                      data-city="{{ addr.city }}"
                      data-zipcode="{{ addr.zipcode }}"
                      data-country="{{ addr.country }}"
                      data-contact="{{ addr.contact }}">
                      <div>
                        <strong>{{ addr.full_name }}</strong><br>
                        {{ addr.address_line1 }}, {{ addr.street }}<br>
                        {{ addr.city }} - {{ addr.zipcode }}, {{ addr.country }}<br>
                        <small>ðŸ“ž {{ addr.contact }}</small>
                      </div>
                      <button type="button" class="btn btn-sm btn-primary select-address">Select</button>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          <div class="mb-2 d-flex justify-content-between">
            <span>Total Price:</span>
            <strong>â‚¹{{ total_price }}</strong>
          </div>
          <div class="mb-2 d-flex justify-content-between">
            <span>Shipping Charge:</span>
            <strong>â‚¹{{ shipping_charge }}</strong>
          </div>
          <div class="d-flex justify-content-between" style="font-size: 1.2rem;">
            <span>Final Total:</span>
            <strong style="color: #d9534f;">â‚¹{{ final_total }}</strong>
          </div>

          <!-- Hidden fields -->
          <input type="hidden" name="total_price" value="{{ total_price }}">
          <input type="hidden" name="shipping_charge" value="{{ shipping_charge }}">
          <input type="hidden" name="final_total" value="{{ final_total }}">

          <div class="form-check mt-3 mb-3">
            <input class="form-check-input" type="checkbox" id="confirm" required>
            <label class="form-check-label" for="confirm">
              I confirm the above details are correct.
            </label>
          </div>

          <div class="d-flex gap-2 mb-3">
            <a href="{% url 'cart' %}"  class="btn btn-secondary flex-grow-1">Back to Cart</a>
            <button type="submit" class="btn btn-warning flex-grow-1">ðŸ“¦ Place Order</button>
          </div>
        {% else %}
          <p>No items in cart. <a href="{% url 'product_list' %}">Shop now</a></p>
        {% endif %}
      </div>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const addressOptions = document.querySelectorAll(".address-option");
  const selectedAddressDiv = document.getElementById("selected-address");
  const addressInput = document.getElementById("selected_address_input");

  const fullnameField = document.getElementById("fullname");
  const contactField = document.getElementById("contact");
  const add1Field = document.getElementById("add1");
  const streetField = document.getElementById("street");
  const cityField = document.getElementById("city");
  const zipcodeField = document.getElementById("zipcode");
  const countryField = document.getElementById("county");

  // Helper function to fill form
  function fillForm(addr) {
    fullnameField.value = addr.dataset.fullname;
    contactField.value = addr.dataset.contact;
    add1Field.value = addr.dataset.line1;
    streetField.value = addr.dataset.street;
    cityField.value = addr.dataset.city;
    zipcodeField.value = addr.dataset.zipcode;
    countryField.value = addr.dataset.country;
    addressInput.value = addr.dataset.id;
  }

  // Load saved selection or default to first
  const savedAddressId = localStorage.getItem("selectedAddressId");
  let initialAddress = null;

  if (savedAddressId) {
    initialAddress = document.querySelector(`.address-option[data-id="${savedAddressId}"]`);
  }
  if (!initialAddress && addressOptions.length > 0) {
    initialAddress = addressOptions[0];
  }
  if (initialAddress) {
    fillForm(initialAddress);
    selectedAddressDiv.innerHTML = `
      <strong>${initialAddress.dataset.fullname}</strong><br>
      ${initialAddress.dataset.line1}, ${initialAddress.dataset.street}<br>
      ${initialAddress.dataset.city} - ${initialAddress.dataset.zipcode}, ${initialAddress.dataset.country}<br>
      <small>ðŸ“ž ${initialAddress.dataset.contact}</small>
      <input type="hidden" name="selected_address" id="selected_address_input" value="${initialAddress.dataset.id}">
    `;
  }

  // Update when address is changed
  addressOptions.forEach(option => {
    option.querySelector(".select-address").addEventListener("click", function () {
      fillForm(option);
      localStorage.setItem("selectedAddressId", option.dataset.id);

      selectedAddressDiv.innerHTML = `
        <strong>${option.dataset.fullname}</strong><br>
        ${option.dataset.line1}, ${option.dataset.street}<br>
        ${option.dataset.city} - ${option.dataset.zipcode}, ${option.dataset.country}<br>
        <small>ðŸ“ž ${option.dataset.contact}</small>
        <input type="hidden" name="selected_address" id="selected_address_input" value="${option.dataset.id}">
      `;

      const modal = bootstrap.Modal.getInstance(document.getElementById("addressModal"));
      modal.hide();
    });
  });

  // Handle order submission
  const orderForm = document.getElementById("orderForm");
  orderForm.addEventListener("submit", function (e) {
    e.preventDefault();

    const formData = new FormData(orderForm);

    fetch(orderForm.action, {
      method: "POST",
      body: formData,
      headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        Swal.fire({
          title: "Order Placed!",
          text: data.message,
          icon: "success",
          confirmButtonText: "Go to My Orders"
        }).then(() => {
          window.location.href = data.redirect_url;
        });
      } else {
        Swal.fire({ title: "Error", text: data.message, icon: "error" });
      }
    })
    .catch(error => {
      Swal.fire({ title: "Error", text: "Could not place the order. Try again.", icon: "error" });
    });
  });
});
</script>
{% endblock %}
